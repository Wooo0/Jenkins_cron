# 多任务功能测试指南

## 功能概述

已成功将原有的单任务定时任务系统升级为支持多任务选择的系统。主要改进包括：

### 前端改进
1. **多任务选择器**：替换原有的单任务下拉选择框为多任务选择界面
2. **搜索筛选**：支持按任务名称搜索和筛选
3. **实时预览**：显示已选任务数量和任务标签
4. **任务列表优化**：在任务列表中显示多任务信息

### 后端改进
1. **数据库扩展**：添加 `jenkins_jobs` 字段存储多任务JSON数组
2. **API兼容性**：保持向后兼容，支持原有的单任务数据
3. **数据处理**：自动处理新旧数据格式

## 测试步骤

### 1. 创建多任务定时任务
1. 打开应用并登录
2. 点击"创建任务"按钮
3. 填写任务名称
4. 选择Jenkins配置
5. 在任务选择器中：
   - 使用搜索框搜索任务
   - 点击任务项进行多选
   - 查看已选任务预览
6. 设置执行方式（一次性或周期性）
7. 点击"创建任务"

### 2. 验证任务列表显示
1. 在任务列表中查看新创建的任务
2. 确认多任务显示正确：
   - 单任务：显示任务名称
   - 多任务：显示"第一个任务 等 N 个任务"格式
   - 多任务显示任务数量徽章

### 3. 验证数据存储
1. 检查数据库中的 `scheduled_jobs` 表
2. 确认 `jenkins_jobs` 字段存储了JSON格式的任务数组
3. 确认 `jenkins_job_name` 字段存储了第一个任务名称（向后兼容）

### 4. 测试向后兼容性
1. 创建单任务定时任务（确保系统正常工作）
2. 查看现有的单任务在任务列表中的显示
3. 确认系统能正确处理旧数据

## 预期结果

### 成功创建多任务
- 任务列表中正确显示多任务信息
- 数据库正确存储多任务数据
- 系统正常运行，无错误

### 向后兼容性
- 原有的单任务定时任务正常工作
- 任务列表正确显示单任务信息
- 系统能同时处理新旧数据格式

## 故障排除

### 常见问题
1. **任务选择器不显示任务**
   - 检查Jenkins配置是否正确
   - 确认Jenkins实例可访问
   - 查看浏览器控制台错误信息

2. **多任务数据保存失败**
   - 检查数据库表结构是否正确
   - 确认 `jenkins_jobs` 字段存在
   - 查看服务器日志

3. **任务列表显示异常**
   - 检查CSS样式是否正确加载
   - 确认JavaScript代码无错误
   - 验证API返回数据格式

### 数据库迁移
系统启动时会自动检查并添加缺失的数据库字段：
- 检查 `scheduled_jobs` 表是否存在 `jenkins_jobs` 字段
- 如果不存在，自动添加该字段
- 迁移过程在应用启动时自动执行

### 调试信息
- 打开浏览器开发者工具查看网络请求
- 检查服务器控制台日志
- 验证数据库数据格式
- 查看数据库迁移日志

## 技术说明

### 数据格式
```json
{
  "name": "定时任务名称",
  "jenkins_config_id": 1,
  "jenkins_jobs": ["job1", "job2", "job3"],
  "jenkins_job_name": "job1", // 向后兼容
  "cron_expression": "0 9 * * 1-5",
  "execute_once": false,
  "execute_time": null,
  "parameters": {}
}
```

### 数据库变更
- 添加 `jenkins_jobs TEXT` 字段到 `scheduled_jobs` 表
- 保持 `jenkins_job_name` 字段用于向后兼容

### API变更
- 创建任务API支持 `jenkins_jobs` 参数
- 获取任务API返回 `jenkins_jobs` 字段
- 保持与现有客户端的兼容性