# MySQL数据库初始化问题诊断指南

## 问题描述
系统重启后显示未初始化状态，`/api/init/status` 接口返回：
```json
{"initialized":false,"hasAdminConfig":false,"adminUsername":null}
```

## 可能的原因

### 1. MySQL数据库连接问题
- MySQL服务不可用
- 连接参数配置错误
- 网络连接问题

### 2. 数据库表丢失
- MySQL数据库被重置
- 表被意外删除
- 数据库权限问题

### 3. 环境变量配置问题
- 数据库连接参数未正确设置
- 配置覆盖问题

## 诊断步骤

### 1. 检查服务器日志
查看应用启动时的日志，重点关注：
- 数据库连接信息
- 数据库初始化状态检查结果
- 任何错误信息

### 2. 验证MySQL连接
```bash
# 在容器内执行
mysql -h [host] -P [port] -u [username] -p [password] -D [database]
```

### 3. 检查数据库表
```sql
-- 连接到MySQL后执行
SHOW TABLES LIKE 'users';
SELECT * FROM users;
```

### 4. 检查环境变量
确认以下环境变量正确设置：
- `DB_TYPE=mysql`
- `DB_HOST`
- `DB_PORT` 
- `DB_NAME`
- `DB_USERNAME`
- `DB_PASSWORD`

## 解决方案

### 方案1：手动初始化数据库
如果表不存在，可以手动执行初始化SQL：

```sql
-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    email VARCHAR(255),
    role VARCHAR(50) DEFAULT 'user',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建其他必要表...
-- Jenkins配置表、定时任务表、执行历史表

-- 插入默认管理员用户（密码为admin123的bcrypt哈希）
INSERT IGNORE INTO users (username, password_hash, email, role) 
VALUES ('admin', '$2a$10$8K1p/a0dRTlB0ZQ1Q2Q3QeQ4Q5Q6Q7Q8Q9Q0Q1Q2Q3Q4Q5Q6Q7Q8Q9Q0', 'admin@example.com', 'admin');
```

### 方案2：检查Kubernetes配置
确保Kubernetes部署配置正确：

1. 检查Secret配置：
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: cron-jenkins-secrets
data:
  jwt-secret: [base64编码的JWT密钥]
  admin-password: [base64编码的管理员密码]
```

2. 检查环境变量传递：
```yaml
env:
- name: DB_TYPE
  value: "mysql"
- name: DB_HOST
  value: "[mysql-host]"
- name: DB_PORT  
  value: "3306"
- name: DB_NAME
  value: "[database-name]"
- name: DB_USERNAME
  value: "[username]"
- name: DB_PASSWORD
  valueFrom:
    secretKeyRef:
      name: [secret-name]
      key: [password-key]
```

### 方案3：添加数据库健康检查
在应用启动时添加数据库健康检查，确保连接正常后再继续初始化。

## 预防措施

1. **使用持久化存储**：确保MySQL数据持久化
2. **定期备份**：定期备份数据库
3. **监控**：设置数据库连接监控
4. **重试机制**：在应用启动时添加数据库连接重试

## 紧急恢复

如果系统无法自动恢复，可以：

1. 重启应用容器
2. 检查MySQL服务状态
3. 手动执行初始化SQL
4. 验证环境变量配置

通过以上步骤，应该能够诊断和解决MySQL数据库初始化问题。